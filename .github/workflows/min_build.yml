name: Mini Build

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ci-${{ github.workflow }}-${{ github.event.pull_request.head.ref || github.ref_name }}
  cancel-in-progress: true

env:
  ROOT: "${{ github.workspace }}"
  SDK_PYTHON: "${{ github.workspace }}/sdk/python"
  SCRIPTS: "${{ github.workspace }}/.github/scripts"
  UV_PYTHON: "3.12"
  PYODIDE_VERSION: "0.27.7"

jobs:
  # ===========================
  # Build Flet Flutter package
  # ===========================
  build_flet_package:
    name: Build Flet Flutter package
    runs-on: ubuntu-latest
    outputs:
      PKG_VER: ${{ steps.versions.outputs.PKG_VER }}
      BUILD_VER: ${{ steps.versions.outputs.BUILD_VER }}
      PYPI_VER: ${{ steps.versions.outputs.PYPI_VER }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # fetch all history
          fetch-tags: true # ensure tags are available

      - name: Setup uv
        uses: astral-sh/setup-uv@v6

      - name: Compute versions
        id: versions
        run: source "${SCRIPTS}/update_build_version.sh"

      - name: Setup Flutter
        uses: kuhnroyal/flutter-fvm-config-action/setup@v3
        with:
          path: '.fvmrc'
          cache: true

      - name: Run tests
        shell: bash
        working-directory: packages/flet
        run: flutter test

  # =============================
  # Build Flet Client for Windows
  # =============================
  build_windows:
    name: Build Flet Client for Windows
    runs-on: windows-2022
    needs:
      - build_flet_package
    env:
      BUILD_VER: ${{ needs.build_flet_package.outputs.BUILD_VER }}
      PYPI_VER: ${{ needs.build_flet_package.outputs.PYPI_VER }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v6

      - name: Setup Flutter
        uses: kuhnroyal/flutter-fvm-config-action/setup@v3
        with:
          path: '.fvmrc'
          cache: true

      - name: Prepare env and patch versions
        shell: bash
        run: |
          source "$SCRIPTS/common.sh"
          patch_python_package_versions
          patch_toml_versions "${SDK_PYTHON}/packages/flet-desktop/pyproject.toml" "$PYPI_VER"

      - name: Build Flutter Windows client
        env:
          RUNNER_DIR: ${{ env.ROOT }}/client/build/windows/x64/runner
          RELEASE_DIR: ${{ env.ROOT }}/client/build/windows/x64/runner/Release
        shell: bash
        working-directory: client
        run: |
          sed -i '/--FAT_CLIENT_START--/,/--FAT_CLIENT_END--/d' pubspec.yaml
          sed -i '/--FAT_CLIENT_START--/,/--FAT_CLIENT_END--/d' lib/main.dart

          flutter build windows --build-name="$BUILD_VER"

          # Copy needed runtime DLLs
          cp "${WINDIR}/system32/msvcp140.dll" "$RELEASE_DIR"
          cp "${WINDIR}/system32/vcruntime140.dll" "$RELEASE_DIR"
          cp "${WINDIR}/system32/vcruntime140_1.dll" "$RELEASE_DIR"

          # Rename Release folder to flet
          mv "$RELEASE_DIR" "${RUNNER_DIR}/flet"

          # Zip up the runner
          cd "$RUNNER_DIR"
          7z a "${ROOT}/client/flet-windows.zip" "flet"

          # Stage app into flet-desktop package
          FLET_DESKTOP_APP="${SDK_PYTHON}/packages/flet-desktop/src/flet_desktop/app"
          mkdir -p "$FLET_DESKTOP_APP"
          cp -r "flet" "${FLET_DESKTOP_APP}/flet"

      - name: Build flet-desktop Python package
        shell: bash
        run: |
          source "$SCRIPTS/common.sh"

          cd "$SDK_PYTHON"
          uv build --package flet-desktop --wheel

          # Ensure glob expands
          shopt -s nullglob

          for wheel in dist/*-py3-none-any.whl; do
            repackage_wheel_with_tag "$wheel" "py3-none-win_amd64"
            repackage_wheel_with_tag "$wheel" "py3-none-win32"
            rm -f "$wheel"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          if-no-files-found: error
          path: |
            client/flet-windows.zip
            sdk/python/dist/*.whl

  # =====================================
  # Build flet, flet-cli and flet-desktop
  # =====================================
  build_flet_cli_desktop:
    name: Build flet, flet-cli and flet-desktop Python packages
    runs-on: ubuntu-latest
    needs:
      - python_tests
      - build_flet_package
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v6

      - name: Build Python packages
        shell: bash
        run: |
          source "$SCRIPTS/common.sh"
          patch_python_package_versions
          uv build --package flet-cli
          uv build --package flet
          uv build --package flet-desktop --sdist
          update_flet_wheel_deps dist

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flet-cli-desktop-python-distribution
          path: |
            sdk/python/dist/*.whl
            sdk/python/dist/*.tar.gz

  # ==============
  # GitHub Release
  # ==============
  release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: py_publish
    if: ${{ startsWith(github.ref, 'refs/tags/') }}
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Create/Update GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          preserve_order: true
          overwrite_files: true
          fail_on_unmatched_files: true
          files: |
            dist/**/*.whl
            dist/**/*.tar.gz
            dist/**/*.zip
